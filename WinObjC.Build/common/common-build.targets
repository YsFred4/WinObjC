<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

<Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets"/>

<PropertyGroup>
    <GetPackageContentsDependsOn>
        $(GetPackageContentsDependsOn);
        Build;
    </GetPackageContentsDependsOn>
</PropertyGroup>

<Target Name="GetPackageContentsForOtherConfigurations" BeforeTargets="GetPackageContents">
     <!-- Time to get fancy. WinObjCRT is needed in both debug and release configurations in the package. The below target re-runs the build automagically 
     so here we just need to make sure to pick up the extra outputs. The same trick is used by re-running the AddBuiltOutput target on the other configs. -->
    <ItemGroup>
      <_PackTargetPlat Include="%(ProjectConfiguration.Platform)"
              Condition="'%(ProjectConfiguration.Configuration)' == '$(Configuration)' AND '%(ProjectConfiguration.Platform)' != '$(Platform)'" />
    </ItemGroup>

    <Message Text="Calling GetPackageContents another time on $(MSBuildThisFile) for the following Platforms: @(_PackTargetPlat)" Importance="High" Condition="'$(SkipRerunAddBuiltOutputForOtherConfig)' != 'true'"/>
    <MSBuild Projects="$(MSBuildProjectFile)"
         Targets="GetPackageContents"
         Properties="SkipRerunAddBuiltOutputForOtherConfig=true;Configuration=$(Configuration);Platform=%(_PackTargetPlat.Identity);ShouldUnsetParentConfigurationAndPlatform=false;"
         Condition="'$(SkipRerunAddBuiltOutputForOtherConfig)' != 'true'">
      <Output TaskParameter="TargetOutputs" ItemName="_OtherConfigPackageContent" />
    </MSBuild>

    <ItemGroup Condition="'$(SkipRerunAddBuiltOutputForOtherConfig)' != 'true'">
      <PackageFile Include="@(_OtherConfigPackageContent)" />
    </ItemGroup>

</Target>

</Project>