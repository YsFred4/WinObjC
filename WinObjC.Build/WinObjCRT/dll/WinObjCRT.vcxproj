<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|ARM">
      <Configuration>Debug</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM">
      <Configuration>Release</Configuration>
      <Platform>ARM</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="$(MSBuildThisFileDirectory)\dllmain.cpp" />
  </ItemGroup>
  <ItemGroup>
    <None Include="WinObjCRT.def" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\lib\WinObjCRTLib.vcxproj">
      <Project>{faebdba2-dff7-4944-9b13-bcc4da340804}</Project>
    </ProjectReference>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <ProjectGuid>{585b4870-0d6b-43a6-8e7e-ad08f7f507b6}</ProjectGuid>
    <RootNamespace>WinObjCRT</RootNamespace>
    <AppContainerApplication>true</AppContainerApplication>
    <OutputName>WinObjCRT</OutputName>
    <IncludeOutputsInPackage>false</IncludeOutputsInPackage>
    <IncludeContentInPackage>false</IncludeContentInPackage>
  </PropertyGroup>
  <PropertyGroup Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
  </PropertyGroup>
  <ImportGroup Label="ExtensionSettings">
    <Import Project="$(MSBuildThisFileDirectory)..\..\common\common-build.props" />
  </ImportGroup>
  <ItemDefinitionGroup>
    <Link>
      <ModuleDefinitionFile>WinObjCRT.def</ModuleDefinitionFile>
    </Link>
  </ItemDefinitionGroup>
  <ImportGroup Label="ExtensionTargets">
    <Import Project="$(MSBuildThisFileDirectory)..\..\common\common-build.targets" />
  </ImportGroup>
  <ItemGroup>
    <None Include="Project.json" />
  </ItemGroup>

  <Target Name="AddBuiltOutput" 
          BeforeTargets="GetPackageContents" 
          DependsOnTargets="$(ComputeLinkInputsTargets)">
    <ItemGroup>      
    <_ImportLibraryFileNames  Include="@(Link -> '%(ImportLibrary)')"></_ImportLibraryFileNames>
      <PackageFile Include="@(BuiltProjectOutputGroupOutput -> '%(FinalOutputPath)')">
        <PackagePath>build\lib\$(TargetOsAndVersion)\$(PlatformTarget)\$(Configuration)\%(Filename)%(Extension)</PackagePath>
      </PackageFile>
      <PackageFile Include="@(_ImportLibraryFileNames->Distinct())">
        <PackagePath>build\lib\$(TargetOsAndVersion)\$(PlatformTarget)\$(Configuration)\%(Filename)%(Extension)</PackagePath>
      </PackageFile>
    </ItemGroup>
  </Target>


  <UsingTask TaskName="GetProjectUniqueName"
           TaskFactory="CodeTaskFactory"
           AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll" >
  <ParameterGroup>
    <ProjectGuid ParameterType="System.String" Required="true"/>
    <SolutionPath ParameterType="System.String" Required="true"/>
    <ProjectUniqueName ParameterType="System.String" Output="true"/>
  </ParameterGroup>
  <Task>
    <Reference Include="System"/>
    <Reference Include="System.Reflection"/>
    <Reference Include="Microsoft.Build"/>
    <Using Namespace="Microsoft.Build.Construction"/>
    <Using Namespace="System.Reflection"/>
    <Using Namespace="System"/>
    <Code Type="Fragment" Language="cs">
      <![CDATA[
        var solution = SolutionFile.Parse(SolutionPath);
        var project = solution.ProjectsByGuid[System.Guid.Parse(ProjectGuid).ToString("B")];
        
        try {
          ProjectUniqueName = (String)(project.GetType().GetMethod("GetUniqueProjectName", BindingFlags.NonPublic).Invoke(project, null));
        } catch { }
      ]]>
    </Code>
  </Task>
</UsingTask>


  <Target Name="BuidOtherConfig" Condition="'$(SkipRerunAddBuiltOutputForOtherConfig)' != 'true'">



    <ItemGroup>
      <_PackTargetConfig Include="%(ProjectConfiguration.Configuration)"
              Condition="'%(ProjectConfiguration.Platform)' == '$(Platform)' AND '%(ProjectConfiguration.Configuration)' != '$(Configuration)'" />
    </ItemGroup>

    <Message Text="Calling Build another time on $(MSBuildProjectFile) for the following Configs: @(_PackTargetConfig)" Importance="High"/>
    <GetProjectUniqueName SolutionPath="$(SolutionPath)" ProjectGuid="$(ProjectGuid)">
      <Output ItemName="_ProjectUniqueName" TaskParameter="ProjectUniqueName"/> 
    </GetProjectUniqueName>

    <MSBuild Projects="$(SolutionPath)"
         Targets="$(_ProjectUniqueName)"
         Properties="SkipRerunAddBuiltOutputForOtherConfig=true;Platform=$(Platform);Configuration=%(_PackTargetConfig.Identity);ShouldUnsetParentConfigurationAndPlatform=false"
        >
      <Output TaskParameter="TargetOutputs" ItemName="_OtherConfigPackageContent" />
    </MSBuild>

    <ItemGroup>
      <PackageFile Include="@(_OtherConfigPackageContent)" />
    </ItemGroup>


  </Target>

 
</Project>